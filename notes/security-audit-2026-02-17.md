# Gondolin VM Security Audit

**Date**: 2026-02-17
**Auditor**: Claude Code (from inside a running Gondolin VM)
**Method**: Code review + active probing from guest

---

## Overall Assessment

Gondolin uses a **hardware VM (QEMU/KVM)** as its isolation boundary, which is fundamentally strong. The guest is a minimal Alpine Linux initramfs talking to the host over virtio serial ports. Most of the serious attack surface is on the **host-side protocol handlers** rather than the guest. That said, several noteworthy issues were found:

---

## ðŸ”´ HIGH Severity

### 1. MITM CA Installed â€” All TLS is Transparent-Proxied

- The **only** CA cert in `/etc/ssl/certs/ca-certificates.crt` is `gondolin-mitm-ca` â€” a self-signed RSA-2048 cert generated by the host.
- **All HTTPS traffic from the guest is MITM'd** by the host. Confirmed: `curl -sv https://api.github.com` shows the peer cert issued by `CN=gondolin-mitm-ca`.
- **Impact**: Any code running in the guest that assumes TLS provides end-to-end confidentiality is wrong. The host can read/modify all HTTPS traffic. This is by design (for secret substitution), but...
- **Risk**: If an attacker compromises the host-side Gondolin process, they inherit a MITM position on all guest traffic. The CA key lives in `~/.cache/gondolin/ssl/ca.key` on the host with user permissions.
- **Recommendation**: Document the MITM threat model prominently. Consider certificate pinning warnings for guest tooling.

### 2. Guest Runs as Root with ALL Capabilities, No Seccomp

- `CapEff: 000001ffffffffff` â€” every Linux capability is granted
- `Seccomp: 0` â€” no seccomp filters on any process
- `modules_disabled: 0` â€” kernel modules can be loaded at will
- **Impact**: A compromised guest process has maximum kernel privilege. Can load modules, create raw sockets, manipulate network stack, mount filesystems.
- **In context**: The VM boundary makes this less critical than it would be in a container, but it increases the blast radius of any guest-side kernel exploit. If the Linux kernel has a privilege escalation, the guest is already at max privilege and can focus purely on VM escape.
- **Recommendation**: Drop capabilities not needed by the guest workload. Enable a basic seccomp profile. Set `modules_disabled=1` after boot.

### 3. Guest Can Overwrite Its Own Binaries (sandboxd, sandboxfs, etc.)

- Successfully ran: `cp /bin/sh /usr/bin/sandboxd` â€” **succeeded**
- The root ext4 image is writable. A malicious guest can replace `sandboxd` (PID 1) or `sandboxfs` with trojaned versions.
- **Impact**: If the VM is ever rebooted/restarted with the same disk image, the trojaned binaries execute. This is a **persistence mechanism**.
- **Recommendation**: Mount the root filesystem read-only, or at minimum mount `/usr/bin` read-only.

---

## ðŸŸ  MEDIUM Severity

### 4. Unrestricted Outbound Network Access

- `curl https://httpbin.org/ip` returns the host's public IP â€” **full internet access** confirmed
- ICMP ping to `8.8.8.8` works
- DNS resolution for arbitrary domains works (including potential exfiltration domains)
- Raw sockets can be created (`socket.AF_INET, SOCK_RAW, IPPROTO_RAW`)
- **Impact**: A compromised guest can exfiltrate data to any destination, scan networks, and perform DNS tunneling. The network stack does protocol sniffing (HTTP/TLS/SSH) and has an `allowTcpFlow` callback, but the default is `() => true` (allow all).
- **Recommendation**: Network allowlisting should be opt-out (strict by default), not opt-in.

### 5. HTTP CONNECT Blocked, But Protocol Classification is Bypassable

- The network stack (`network-stack.ts`) rejects `CONNECT` method and unknown protocols
- However, the classifier only examines the first 8KB (`MAX_FLOW_SNIFF`). A crafted payload that looks like valid HTTP in the first 8KB could tunnel arbitrary traffic.
- SSH is only detected on configured `sshPorts` (default: `[22]`). Running SSH on a non-standard port bypasses classification.
- **Recommendation**: Consider allowlisting destination IPs/ports in addition to protocol sniffing.

### 6. All Gateway Ports Appear "Open"

- Every tested port on `192.168.127.1` (22, 80, 443, 8080, 3000, 8443, 9090) shows as OPEN
- This is because the network stack is a userspace TCP implementation â€” it SYN-ACKs everything then applies policy later
- **Not a direct vulnerability** but makes it harder for the guest to distinguish real services from the NAT

### 7. DNS Returns Fake/Synthetic Addresses

- `nslookup google.com` returns `192.0.2.1` (TEST-NET) and `2001:db8::1` (documentation prefix)
- This is likely the DNS proxy returning synthetic addresses for the MITM to work, but it means guest DNS isn't trustworthy for IP-based access decisions.

---

## ðŸŸ¡ LOW Severity

### 8. Workspace `.git/config` Exposes Remote URLs

- Contains `git@github.com:tesla3/gondolin.git` â€” reveals a secondary GitHub account/remote
- Git configs can contain credential helpers, tokens, or proxy settings
- **Recommendation**: Consider shadowing `.git/config` or stripping credential-related lines

### 9. No File-Level Shadowing Active

- `/etc/gondolin/` directory is empty (no shadow config visible)
- The `ShadowProvider` in the codebase is sophisticated (blocks symlink bypass, supports tmpfs overlay) but there's no evidence it's configured for this session
- Files like `.env`, `.envrc`, SSH keys etc. would be visible if present in the mounted directories

### 10. /data Mount Exposes Raw View of All Bind-Mounted Content

- `/data/workspace/` and `/data/etc/` are accessible in addition to the bind mounts at `/workspace` and `/etc/gondolin`
- `/data` is essentially the raw sandboxfs mount point â€” same content, but creates a second access path
- Could bypass path-based access controls if any are applied to `/workspace` but not `/data/workspace`

### 11. Guest Path Resolution Uses `root_dir="/"` in Production

- `file_requests.zig` calls `handleFileRead(allocator, &tx, "/", req)` â€” the root dir is `/`
- When root_dir is `/`, `resolveRequestPathInRoot` skips containment checks
- The path validation code **does** properly handle non-root cases (for fuzz harnesses) but in production the guest can read/write any path on its own filesystem via the file protocol

---

## âœ… Things Done Well

1. **VM-level isolation**: The use of a real hardware VM (not containers) is the strongest isolation primitive available
2. **Virtio serial for control plane**: No TCP/IP attack surface on the control channel; virtio-serial is a narrow interface
3. **Protocol framing**: 4MB max frame size, proper length-prefix parsing, CBOR encoding â€” no obvious buffer overflow paths
4. **TCP flow classification**: Blocking CONNECT and unknown protocols is good defense-in-depth
5. **Secret substitution model**: Placeholders in env vars with host-side replacement is a good pattern â€” secrets never enter the guest
6. **ShadowProvider with symlink bypass protection**: The `denySymlinkBypass` feature that resolves symlinks before applying policy is well-designed
7. **Per-secret host allowlists**: Each secret can only be sent to its declared hosts, not just any allowed host
8. **VFS path validation**: `validateName()` blocks `/` and `\0` in filenames; mount router prevents cross-mount renames

---

## Environment Summary

| Property | Value |
|---|---|
| OS | Alpine Linux 3.23 |
| Kernel | 6.18.9-0-virt (x86_64) |
| CPU | 2 cores, Intel (Ice Lake-class) |
| RAM | ~972 MB |
| Disk | 287 MB virtio block (ext4, writable) |
| PID 1 | `/usr/bin/sandboxd` (custom Zig binary) |
| Capabilities | ALL (41 capabilities granted) |
| Seccomp | Disabled |
| Network | 192.168.127.3/24, gateway 192.168.127.1 |
| FUSE mounts | `/data`, `/workspace`, `/etc/gondolin`, `/etc/ssl/certs` |
| TLS | MITM via `gondolin-mitm-ca` |

---

## Methodology

1. **System enumeration**: OS, kernel, capabilities, seccomp, mounts, processes, network
2. **Code review**: Guest Zig source (sandboxd, sandboxfs, sandboxssh, sandboxingress, protocol, path resolution), Host TypeScript source (VFS, RPC service, shadow provider, mount router, network stack, MITM, HTTP hooks, host patterns)
3. **Active probing**: Path traversal, symlink creation, binary overwrite, network scanning, DNS exfiltration test, raw socket creation, FUSE device access, kernel module loading, virtio port access, MITM certificate verification
